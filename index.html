import sqlite3
import requests
import logging
from telegram import Update, InlineKeyboardButton, InlineKeyboardMarkup
from telegram.constants import ParseMode
from telegram.ext import ApplicationBuilder, CommandHandler, CallbackQueryHandler, MessageHandler, filters, ContextTypes, ConversationHandler

logging.basicConfig(format='%(asctime)s - %(name)s - %(levelname)s - %(message)s', level=logging.INFO)

# --- AYARLAR ---
TOKEN = "8515085006:AAHXt2yp7cg7DxljLMoAX4FOpw4b_QiwCOk"
ADMIN_ID = 7234980007 

# API Listesi
BASE_URL = "https://punisher.alwaysdata.net/apiservices"
SULALE_URL = "https://arastir.sbs/api/sulale.php"
ADRES_URL = "https://arastir.sbs/api/adres.php"
GSMTC_URL = "https://arastir.sbs/api/gsmtc.php"

AD, SOYAD, IL, TEK_VERI = range(4)

# --- VERÄ°TABANI ---
def init_db():
    conn = sqlite3.connect('hile_wrox.db')
    conn.execute('CREATE TABLE IF NOT EXISTS users (user_id INTEGER PRIMARY KEY, status TEXT)')
    conn.commit(); conn.close()

def get_status(user_id):
    if user_id == ADMIN_ID: return "Admin"
    conn = sqlite3.connect('hile_wrox.db')
    res = conn.execute("SELECT status FROM users WHERE user_id = ?", (user_id,)).fetchone()
    conn.close()
    return res[0] if res else "Freemium"

# --- TÃœM VERÄ°LERÄ° YAKALAYAN DALGIÃ‡ FONKSÄ°YON ---
def build_paged_output(data, page=0, per_page=5, op=""):
    results = []
    if isinstance(data, list):
        results = data
    elif isinstance(data, dict):
        # API'den gelebilecek tÃ¼m anahtar isimlerini kontrol eder
        results = data.get("soyagaci") or data.get("data") or data.get("results") or \
                  data.get("result") or data.get("Akrabalar") or data.get("Sulale")
        if not results and any(k in str(data).lower() for k in ["tc", "ad", "soyad"]):
            results = [data]

    if not results or not isinstance(results, list):
        return None, 0

    total_items = len(results)
    total_pages = (total_items + per_page - 1) // per_page
    current_items = results[page * per_page : (page + 1) * per_page]
    
    output = f"<b>SORGU SONUCU ({total_items} KayÄ±t)</b>\n\n"
    
    for item in current_items:
        f = {str(k).lower(): v for k, v in item.items()}
        def get_v(keys):
            for k in keys:
                if k in f and f[k] is not None and str(f[k]).strip() != "": return str(f[k]).strip()
            return "Bilinmiyor"

        # BaÅŸlÄ±k belirleme (Yakinlik, Ä°ÅŸyeri adÄ± veya Sorgu tipi)
        title = get_v(["iliski", "yakinlik", "yakinligi", "isyeri_adi", "kurum_adi", "tip"]).upper()
        ad_soyad = f"{get_v(['ad', 'adi', 'name'])} {get_v(['soyad', 'soyadi', 'surname'])}".replace("Bilinmiyor Bilinmiyor", "Bilinmiyor").strip()
        tc = get_v(["tc", "tcno", "tc_no", "kimlik"])
        
        output += f"<b>ğŸ“Œ {title}</b>\nğŸ‘¤ {ad_soyad}\nğŸ†” TC: {tc}\n"
        
        # Ek Bilgiler (Adres, GSM, Okul, IBAN vb.)
        ek = get_v(["il", "adres", "gsm", "telefon", "okul_no", "iban", "sube"])
        if ek != "Bilinmiyor": output += f"ğŸ“ Bilgi: {ek}\n"
        
        # YaÅŸ Hesaplama
        dogum = get_v(["dogum", "dogumtarihi", "dtarih"])
        if dogum != "Bilinmiyor":
            try:
                yil = int(dogum.split('.')[-1]) if '.' in dogum else int(dogum[:4])
                output += f"ğŸ‚ DoÄŸum: {dogum} ({2026 - yil} yaÅŸ)\n"
            except: pass
            
        output += "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n"

    return output[:4000], total_pages

# --- BOT MANTIÄI VE BUTONLAR ---
async def start(update: Update, context: ContextTypes.DEFAULT_TYPE):
    init_db()
    uid = update.effective_user.id
    kb = [[InlineKeyboardButton("ğŸ†“ Ãœcretsiz", callback_data='f')], [InlineKeyboardButton("ğŸ’ VIP", callback_data='v')]]
    text = f"ğŸ’  <b>@HILE_WROX PANEL</b>\nğŸ‘‘ StatÃ¼: <b>{get_status(uid)}</b>"
    if update.message: await update.message.reply_text(text, reply_markup=InlineKeyboardMarkup(kb), parse_mode=ParseMode.HTML)
    else: await update.callback_query.edit_message_text(text, reply_markup=InlineKeyboardMarkup(kb), parse_mode=ParseMode.HTML)
    return ConversationHandler.END

async def handle_buttons(update: Update, context: ContextTypes.DEFAULT_TYPE):
    q = update.callback_query; await q.answer()
    
    if q.data == 'ana_menu': return await start(update, context)
    
    if q.data == 'v':
        if get_status(q.from_user.id) not in ["VIP", "Admin"]:
            await q.edit_message_text("ğŸš« VIP Gerekli.", reply_markup=InlineKeyboardMarkup([[InlineKeyboardButton("ğŸ”™ Geri", callback_data='ana_menu')]])); return
        
        # TÃ¼m sorgularÄ± buraya ekledik
        kb = [
            [InlineKeyboardButton("ğŸ§¬ SoyaÄŸacÄ±", callback_data='api_soyagaci'), InlineKeyboardButton("ğŸ“ Adres PRO", callback_data='api_adrespro')],
            [InlineKeyboardButton("ğŸ‘¤ Ad Soyad Ä°l", callback_data='api_adsoyadpro')],
            [InlineKeyboardButton("ğŸ¢ Ä°ÅŸyeri", callback_data='api_isyeri'), InlineKeyboardButton("ğŸ‘¥ Ä°ÅŸ. Ark.", callback_data='api_isyeriark')],
            [InlineKeyboardButton("ğŸ’³ IBAN Ã‡Ã¶zÃ¼cÃ¼", callback_data='api_iban'), InlineKeyboardButton("ğŸ“ Okul No", callback_data='api_okulno')],
            [InlineKeyboardButton("ğŸ†” TC PRO", callback_data='api_tcpro'), InlineKeyboardButton("ğŸŒ³ SÃ¼lale", callback_data='api_sulale')],
            [InlineKeyboardButton("ğŸ  Adres", callback_data='api_adres'), InlineKeyboardButton("ğŸ“ GSM TC", callback_data='api_gsmtc')],
            [InlineKeyboardButton("ğŸ”™ Geri", callback_data='ana_menu')]
        ]
        await q.edit_message_text("ğŸ’ <b>VIP TÃœM SORGULAR:</b>", reply_markup=InlineKeyboardMarkup(kb), parse_mode=ParseMode.HTML); return

    context.user_data['op'] = q.data
    if "adsoyad" in q.data:
        await q.message.reply_text("ğŸ‘¤ <b>AD girin:</b>", parse_mode=ParseMode.HTML); return AD
    else:
        prompt = "TC No" if "iban" not in q.data else "IBAN"
        await q.message.reply_text(f"ğŸ” Sorgulanacak <b>{prompt}</b> girin:", parse_mode=ParseMode.HTML); return TEK_VERI

async def execute_api(update: Update, context: ContextTypes.DEFAULT_TYPE):
    op = context.user_data.get('op', '').replace('api_', '')
    val = update.message.text
    wait = await update.message.reply_text("â³ Veriler sorgulanÄ±yor...")
    
    try:
        # API URL SeÃ§imi
        urls = {"sulale": SULALE_URL, "adres": ADRES_URL, "gsmtc": GSMTC_URL}
        url = urls.get(op, f"{BASE_URL}/{op}.php")
        
        params = {
            'ad': context.user_data.get('ad'), 'soyad': context.user_data.get('soyad'),
            'il': context.user_data.get('il'), 'tc': val, 'tcno': val, 'gsm': val, 'iban': val
        }
        
        r = requests.get(url, params=params, timeout=30).json()
        txt, tot = build_paged_output(r, 0, op=op)
        
        await wait.delete()
        if txt:
            kb = [] # Sayfalama eklenebilir
            kb.append([InlineKeyboardButton("ğŸ”™ Ana MenÃ¼", callback_data="ana_menu")])
            await update.message.reply_text(txt, reply_markup=InlineKeyboardMarkup(kb), parse_mode=ParseMode.HTML)
        else:
            await update.message.reply_text("âŒ KayÄ±t bulunamadÄ±.")
    except:
        await wait.edit_text("âŒ Sunucu hatasÄ± veya API yanÄ±t vermiyor.")
    
    return ConversationHandler.END

# Ad-Soyad-Ä°l iÃ§in ara aÅŸamalar
async def get_ad(u, c): c.user_data['ad'] = u.message.text; await u.message.reply_text("ğŸ‘¤ <b>SOYAD:</b>"); return SOYAD
async def get_soyad(u, c): 
    c.user_data['soyad'] = u.message.text
    if c.user_data.get('op') == 'api_adsoyadpro':
        await u.message.reply_text("ğŸ“ <b>Ä°L (TÃ¼m TR iÃ§in '.'):</b>"); return IL
    return await execute_api(u, c)
async def get_il(u, c): c.user_data['il'] = u.message.text; return await execute_api(u, c)

if __name__ == '__main__':
    init_db()
    app = ApplicationBuilder().token(TOKEN).build()
    app.add_handler(CommandHandler("start", start))
    app.add_handler(ConversationHandler(
        entry_points=[CallbackQueryHandler(handle_buttons)],
        states={
            AD: [MessageHandler(filters.TEXT & ~filters.COMMAND, get_ad)],
            SOYAD: [MessageHandler(filters.TEXT & ~filters.COMMAND, get_soyad)],
            IL: [MessageHandler(filters.TEXT & ~filters.COMMAND, get_il)],
            TEK_VERI: [MessageHandler(filters.TEXT & ~filters.COMMAND, execute_api)]
        },
        fallbacks=[CommandHandler("start", start)]
    ))
    app.run_polling()
